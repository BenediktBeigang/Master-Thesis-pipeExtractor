= Pipe-Extractor

Extraction of pipes and pipe components from classified pointclouds.

ifdef::env-github[]
[source,mermaid]
endif::[]
ifndef::env-github[]
[mermaid]
endif::[]
----
flowchart LR
  %% ===== Styles =====
  classDef external stroke-width:1px,stroke-dasharray: 10 5;
  classDef header fill:#fff,stroke-width:1.5px;
  classDef normal stroke-width:1px;

  %% ===== Inputs =====
  I1["Predicted pointclouds (Label: Pipe)"]
  I3["Predicted pointclouds (Label: Component)"]

  %% ===== Phase 1 (group) =====
  subgraph P1["Phase 1: Pipe instance detection"]
    direction TB
    P1a["Phase 1a: Slice hough search"]
    P1b["Phase 1b: Slice clustering & merging"]
    P1c["Phase 1c: Global clustering & merging"]
    P1a --> P1b -->|"{Σ}"| P1c
  end

  %% ===== Phase 2 =====
  P2["Phase 2: Pipe instance finetuning"]

  %% ===== Phase 3 =====
  P3["Phase 3: Pipe component detection"]

  %% ===== Output ======
  J["Export features"]
  O["Geodatenserver"]

  %% ===== Flow + edge labels =====
  I1 --> P1
  P1 -->|approximated pipe instances| P2
  P2 -->|final pipe instances| P3
  I3 --> P3
  P2 -->|final pipe instances| J
  P3 -->|final pipe components| J
  J -->|.geojson| O

  %% ===== Class assignments =====
  class I1,I3,O external
  class P1a,P1b,P1c,P2,P3 normal
----

.Where to find what
[cols="1,2,2",options="header"]
|===
| Stage | Description | Functions

| Phase 1: Pipe instance detection 
| Takes xyz points with label `Pipe` and returns approximated pipe instances.
| 
link:pipe_extraction/pipe_extraction_hough_parallel.py[`extract_pipes()`] +
link:pipe_extraction/parallel_slices.py[`worker_process_slice()`]

| Phase 1a: Pipe instance detection 
| Slice pointcloud in Z and detect lines via 2D-Hough.
| link:pipe_extraction/calcSlice.py[`find_lines_in_slice()`]

| Phase 1b: Slice clustering & merging 
| For every Slice cluster Hough segments with DBSCAN and merge segments. 
| 
link:pipe_extraction/clustering_hough.py[`cluster_segments()`] +
link:pipe_extraction/merge_segments.py[`merge_segments_in_clusters()`]

| Phase 1c: Clustering & merging 
| For all segments in all slices cluster Hough segments with DBSCAN and merge segments. 
|
link:pipe_extraction/clustering_hough.py[`cluster_segments()`] +
link:pipe_extraction/merge_segments.py[`merge_segments_in_clusters()`] 

| Phase 2: Finetuning (Snapping) 
| Refine approximated pipes against raw points. 
| 
link:pipe_extraction/parallel_snapping.py[`snap_segments_to_point_cloud_data_parallel()`] +
link:pipe_extraction/snapToPipe.py[`process_single_segment()`]

| Phase 3: Components 
| Takes xyz points with label `Component` (and found pipes) to cluster and detect pipe components. 
| link:pipeComponent_extraction/pipeComponentExtraction.py[`extract_pipeComponents()`]

| (Evaluation) 
| Measure coverage and error (`pipeEval`, `componentEval`), render visualisations. 
| 
link:eval/pipeEval.py[`pipeEval()`] +
link:eval/componentEval.py[`componentEval()`] 
|===

== Installation and usage

The usage of this pipeline requires a working conda/mamba installation.
The `pyproject.toml` lists all required dependencies, but it's recommended to create the environment via the provided `environment.yml`.

[source,bash]
----
conda env create -f environment.yml
conda activate pipe-extraction
pip install -e .

# Minimal usage:
python pipeExtraction_cli.py --input <filename>.las

# With all options:
python pipeExtraction_cli.py --input <filename>.las \\
--config_path <config>.json  \\ # custom configuration
--gt_path <ground_truth>.geojson \\ # ground truth for evaluation
--eval \\ # enable evaluation (gt_path required)
--output_dir <output_folder> # custom output folder
----

== Configuration

All pipeline parameters are stored in link:config.json[`config.json`]:

* `parallel_worker`: number of parallel workers for slice processing and snapping.
* `slice_thickness`: thickness of slices in Z direction.
* `hough`: control the Hough transform parameters.
* `global_cluster_and_merge`: sets DBSCAN epsilon, minimum samples, and gap thresholds for global merging.
* `slice_cluster_and_merge`: provides slice-specific clustering and merge settings.
* `snapping`: governs sampling density, bounding boxes, and RANSAC fitting.
* `pipeComponent_clustering`: sets HDBSCAN parameters for component detection.

== Outputs

* `output/obj/*.obj` — different results during pipe extraction phases for visualization in _CloudCompare_.
* `output/geojson/*.geojson` — combined pipes and components via link:export_geojson.py[`export_geojson.export_geojson`].
* `output/metrics/*.json` — pipe and component metrics from link:eval/pipeEval.py[`eval.pipeEval.pipeEval`] and link:eval/componentEval.py[`eval.componentEval.componentEval`].
* `output/plots/*.png` — bar/box plots from link:eval/plots/pipeClassPlot.py[`eval.plots.pipeClassPlot.plot_segmentClasses`] and link:eval/plots/componentClassPlot.py[`eval.plots.componentClassPlot.plot_componentClasses`].
